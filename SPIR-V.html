<!doctype html><html lang="en"><head><meta charset="utf8"><title>Argdown Document</title><link rel="stylesheet" href="./argdown.css"></head><body><div class="argdown"><h2 data-line="1" id="heading-webgpu-shading-language" class="has-line heading"><span class="statement-content">WebGPU Shading Language</span></h2><div data-line="16" class="statement has-line top-level"><span id="statement-spir-v" class="definition statement-definition definiendum top-level">[<span class="title statement-title">SPIR-V</span>]: </span><span class="statement-content top-level">We should define a safe subset of SPIR-V and <a href="https://github.com/gpuweb/gpuweb/issues/44">accept it directly</a> in WebGPU implementations.</span></div><div data-line="19" class="argument has-line top-level"><a id="argument-spir-v-is-too-low-level" href="#argument-spir-v-is-too-low-level" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">SPIR-V is too low level</span>&gt;: </a><span class="statement-content top-level">SPIR-V is meant to be fed into drivers, as well as processed by tools, while WebGPU needs to be able to generate HLSL and MSL, which are higher level. This makes some translation paths inefficient and awkward to implement.</span><div class="relations"><div data-line="22" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="22" class="statement has-line"><span class="statement-content">it has a lot of instructions, some with <a href="https://github.com/gpuweb/gpuweb/issues/34">undefined behavior</a>.</span></div></div><div data-line="23" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="23" class="statement has-line"><span class="statement-content">it represents control flow as a graph (CFG), which forces us to recover the structure when generating HLSL and MSL.</span></div></div><div data-line="25" class="has-line incoming attack relation"><div class="incoming attack relation-symbol"><span>-&gt;</span></div><div data-line="25" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="27" class="statement has-line top-level"><span id="statement-text-formats-are-better-on-the-web" class="definition statement-definition definiendum top-level">[<span class="title statement-title">Text formats are better on the Web</span>]: </span><span class="statement-content top-level">Using a text human readable format is more idiomatic to the Web.</span><div class="relations"><div data-line="28" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="28" class="statement has-line"><span class="statement-content">JavaScript is the language of the Web.</span></div></div><div data-line="29" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="29" class="statement has-line"><span class="statement-content">Being able to see the web source and tinker with it was one of the principles of the Web as it was emerging, and it's still important today.</span></div></div><div data-line="32" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="32" class="statement has-line"><span class="statement-content">WASM is the new form of the language of the Web, and it's binary.</span></div></div><div data-line="33" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="33" class="statement has-line"><span class="statement-content">Parsing a text format is more complex and takes more time than parsing a SPIR-V binary.</span><div class="relations"><div data-line="34" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="34" class="statement has-line"><span class="statement-content">shader parsing is only a couple of % for the time total spent in a pipeline creation. Most time is still spent within the driver.</span></div></div></div></div></div><div data-line="36" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="36" class="statement has-line"><span class="statement-content">Text is more verbose and redundant, from the point of view of the data transferred from the client.</span><div class="relations"><div data-line="37" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="37" class="statement has-line"><span class="statement-content">there is no indication that text-based shaders are going to be larger than SPIR-V, which is known for its big size. Compressed, text should be close in size, if not smaller.</span></div></div></div></div></div><div data-line="39" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="39" class="statement has-line"><span class="statement-content">Text format is more complex than binary</span><div class="relations"><div data-line="40" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="40" class="statement has-line"><span class="statement-content">complexity is independent of the form. There can be complex binary languages and simple text ones.</span></div></div></div></div></div><div data-line="41" class="has-line incoming attack relation"><div class="incoming attack relation-symbol"><span>-&gt;</span></div><div data-line="41" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="43" class="argument has-line top-level"><a id="argument-spir-v-cant-be-used-in-the-tests-and-examples" href="#argument-spir-v-cant-be-used-in-the-tests-and-examples" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">SPIR-V can't be used in the tests and examples</span>&gt;: </a><span class="statement-content top-level">If we can't write it, we'd be writing tests and examples in another language, which would make WebGPU less strong API.</span><div class="relations"><div data-line="45" class="has-line incoming attack relation"><div class="incoming attack relation-symbol"><span>-&gt;</span></div><div data-line="45" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="47" class="argument has-line top-level"><a id="" href="#argument-spir-v-is-developed-indepenently" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">SPIR-V is developed indepenently</span>&gt;: </a><span class="statement-content top-level">SPIR-V is developed by a working group inside Khronos, which may bring tension to using it.</span></div><div id="argument-spir-v-is-developed-indepenently" data-line="50" class="pcs has-line"><div data-line="50" class="has-line premise pcs-statement"><div class="statement-nr">(<span>1</span>)</div><div data-line="50" class="statement has-line"><span class="statement-content">Khronos working group has different constraints, it doesn't have any obligation to make SPIR-V changes that WebGPU would need.</span></div></div><div data-line="52" class="has-line inference"><span class="inference-rules"></div><div data-line="53" class="has-line intermediary-conclusion pcs-statement"><div class="statement-nr">(<span>2</span>)</div><div data-line="53" class="statement has-line"><span class="statement-content">It is likely that WebGPU would need to have different versions of the same functionality present in core SPIR-V, like the instructions for ray tracing.</span></div></div><div data-line="55" class="has-line inference"><span class="inference-rules"></div><div data-line="56" class="has-line main-conclusion pcs-statement"><div class="statement-nr">(<span>3</span>)</div><div data-line="56" class="statement has-line"><span class="statement-content">That will effectively lead to the forking SPIR-V</span><div class="relations"><div data-line="57" class="has-line incoming attack relation"><div class="incoming attack relation-symbol"><span>-&gt;</span></div><div data-line="57" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div></div></div><div data-line="59" class="argument has-line top-level"><a id="argument-nobody-wants-yet-another-shading-language" href="#argument-nobody-wants-yet-another-shading-language" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">Nobody wants yet another shading language</span>&gt;: </a><span class="statement-content top-level">we already have a diversity of shading languages, as well as huge shader code bases. Adding support for another one is something nobody is excited about.</span><div class="relations"><div data-line="61" class="has-line incoming support relation"><div class="incoming support relation-symbol"><span>+&gt;</span></div><div data-line="61" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="63" class="argument has-line top-level"><a id="argument-parsing-text-is-prone-to-errors" href="#argument-parsing-text-is-prone-to-errors" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">Parsing text is prone to errors</span>&gt;: </a><span class="statement-content top-level">there is a large class of parsing/processing errors that doesn't exist in a binary format like SPIR-V/</span><div class="relations"><div data-line="64" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="64" class="statement has-line"><span class="statement-content">Angle team has experience with WebGL shading language, there is a impressive <a href="https://docs.google.com/spreadsheets/d/1bjfZJcvGPI4M6Df5HC8BPQXbl847RpfsFKw6SI6_T30/edit">bug list</a></span></div></div><div data-line="65" class="has-line incoming support relation"><div class="incoming support relation-symbol"><span>+&gt;</span></div><div data-line="65" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="67" class="argument has-line top-level"><a id="argument-spir-v-is-well-specified" href="#argument-spir-v-is-well-specified" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">SPIR-V is well-specified</span>&gt;: </a><span class="statement-content top-level">It's an existing modern shading language that has a very detailed specification and a good conformance test suite.</span><div class="relations"><div data-line="69" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="69" class="statement has-line"><span class="statement-content">SPIR-V isn't tested directly, but rather via GLSL</span></div></div><div data-line="70" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="70" class="statement has-line"><span class="statement-content">It's specified in 2 different documents: language itself and the execution environment. Sometimes it's not easy to figure out which of them is responsible for describing a particular behavior.</span><div class="relations"><div data-line="72" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="72" class="statement has-line"><span class="statement-content">WebGPU could compile both of these pieces together with the main specification</span></div></div></div></div></div><div data-line="73" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="73" class="statement has-line"><span class="statement-content">It has a memory model</span><div class="relations"><div data-line="74" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="74" class="statement has-line"><span class="statement-content">WebGPU can borrow the memory model without taking the full SPIR-V</span></div></div></div></div></div><div data-line="75" class="has-line incoming support relation"><div class="incoming support relation-symbol"><span>+&gt;</span></div><div data-line="75" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div><div data-line="77" class="argument has-line top-level"><a id="argument-spir-v-has-a-large-ecosystem" href="#argument-spir-v-has-a-large-ecosystem" class="definition argument-definition definiendum top-level">&lt;<span class="title argument-title">SPIR-V has a large ecosystem</span>&gt;: </a><span class="statement-content top-level">Leveraging this ecosystem can help WebGPU to succeed.</span><div class="relations"><div data-line="78" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="78" class="statement has-line"><span class="statement-content">There are libraries for reflecting SPIR-V in popular languages: <a href="https://github.com/KhronosGroup/SPIRV-Tools">C++</a>, <a href="https://crates.io/crates/rspirv">Rust</a>, <a href="https://github.com/vulkan-go/spv">Go</a>, <a href="https://github.com/kristerw/spirv-tools">Python</a> etc.</span></div></div><div data-line="79" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="79" class="statement has-line"><span class="statement-content">There is both an optimizer and a validator in SPIRV-Tools.</span></div></div><div data-line="80" class="has-line outgoing support relation"><div class="outgoing support relation-symbol"><span>+</span></div><div data-line="80" class="statement has-line"><span class="statement-content"><a href="https://github.com/KhronosGroup/SPIRV-Cross">SPIRV-Cross</a> exists, it can translate SPIR-V into MSL, HLSL, and GLSL</span><div class="relations"><div data-line="81" class="has-line outgoing attack relation"><div class="outgoing attack relation-symbol"><span>-</span></div><div data-line="81" class="statement has-line"><span class="statement-content">After inspecting it and experimenting with it, both Google and Mozilla decided to not use SPIRV-Cross. It's hard to bring it into shape that will be suitable for shipping in a browser.</span></div></div></div></div></div><div data-line="83" class="has-line incoming support relation"><div class="incoming support relation-symbol"><span>+&gt;</span></div><div data-line="83" class="statement has-line"><a href="#statement-spir-v" class="reference statement-reference">[<span class="title statement-title">SPIR-V</span>] </a></div></div></div></div></div></body></html>